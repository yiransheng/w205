<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <meta name="generator" content="Madoko, version 0.9.8-beta" />
  <meta name="viewport" content="initial-scale=1.0" />
  <meta name="author" content="Yiran Sheng" />
  <title>W205 Lab 6</title>
  <style  class="link">
  /* ---------------------------------------------------
     Various settings to display madoko elements correctly.
     For example, lines in tables or a table of contents.
  
     All rules use specific madoko classes and never just
     a generic element. This means one can safely include
     this CSS into any web page without affecting non-madoko
     content.
  ----------------------------------------------------*/
  
  /* The table of  contents */
  .madoko .toc>.tocblock .tocblock .tocblock {
    margin-left: 2.5em;
  }
  
  .madoko .toc>.tocblock .tocblock {
    margin-left: 1.7em;
  }
  
  .madoko .toc>.tocblock>.tocitem {
    font-weight: bold;
  }
  
  .madoko .toc {
    margin-top: 1em;
  }
  
  /* Paragraphs */
  .madoko p.para-continue {
    margin-bottom: 0pt;
  }
  
  .madoko .para-block+p {
    margin-top: 0pt;
  }
  
  .madoko ul.para-block, .madoko ol.para-block {
    margin-top: 0pt;
    margin-bottom: 0pt;
  }
  
  .madoko ul.para-end, .madoko ol.para-end {
    margin-bottom: 1em;
  }
  
  .madoko dl {
    margin-left: 0em;
  }
  
  .madoko blockquote {
    font-style: italic;
  }
  
  /* Local page links do not get an underline unless hovering */
  .madoko a.localref {
    text-decoration: none;
  }
  .madoko a.localref:hover {
    text-decoration: underline;
  }
  
  /* Footnotes */
  .madoko .footnotes {
    font-size: smaller;
    margin-top: 2em;
  }
  
  .madoko .footnotes hr {
    width: 50%;
    text-align: left;
  }
  
  .madoko .footnote { 
    margin-left: 1em;
  }
  .madoko .footnote-before {
    margin-left: -1em;
    width: 1em;
    display: inline-block;
  }
  
  /* Abstract */
  .madoko .abstract>p:first-child:before {
    content: "Abstract. ";
    font-weight: bold;
  }
  
  .madoko .abstract {
    margin-left: 2.7em;
    margin-right: 2.7em;
    font-size: small;
  }
  
  
  /* Alignment */
  .madoko .align-center, .madoko .align-center>p {
    text-align: center !important;
  }
  
  .madoko .align-center pre {
    text-align: left;
  }
  
  .madoko .align-center>* {
    margin-left: auto !important;
    margin-right: auto !important;
  }
  
  .madoko .align-left, .madoko .align-left>p {
    text-align: left !important;
  }
  
  .madoko .align-left>* {
    margin-left: 0pt !important;
    margin-right: auto !important;
  }
  
  .madoko .align-right, .madoko .align-right>p {
    text-align: right !important;
  }
  
  .madoko .align-right>* {
    margin-left: auto !important;
    margin-right: 0pt !important;
  }
  
  .madoko .align-center>table,
  .madoko .align-left>table,
  .madoko .align-right>table {
    text-align: left !important;
  }
  
  
  /* Equations, Figure's etc. */
  .madoko .equation-before {
    float: right;
  }
  
  
  /* Bibliography */
  .madoko .bibitem {
    font-size: smaller;
  }
  
  .madoko .bib-numeric .bibitem {
    margin-left: 3em;
    text-indent: -3em;
  }
  
  .madoko .bibitem-before {
    display: none;
  }
  
  .madoko .bib-numeric .bibitem-before {
    display: inline-block;
    width: 3em;
    text-align: right;
  }
  
  .madoko .bibliography {
  }
  
  .madoko .bibsearch {
    font-size: x-small;
    text-decoration:none;
    color: black;
    font-family: "Segoe UI Symbol", Symbola;
  }
  
  /* General */
  .madoko .block, .madoko .figure, .madoko .bibitem, .madoko .equation, .madoko div.math {
    margin-top: 1ex;
    margin-bottom: 1ex;
  }
  
  .madoko .figure {
    padding: 0.5em;
    margin-left: 0pt;
    margin-right: 0pt;
  }
  
  .madoko .hidden {
    display: none;
  }
  
  .madoko .invisible {
    visibility: hidden;
  }
  
  .madoko.preview .invisible {
    visibility: visible;
    opacity: 0.5;
  }
  
  .madoko code.code, .madoko span.code {
    white-space: pre-wrap;
  }
  
  .madoko hr, hr.madoko {
    border: none;
    border-bottom: black solid 1px;
    margin-bottom: 0.5ex;
  }
  
  .madoko .framed>*:first-child {
    margin-top: 0pt;
  }
  .madoko .framed>*:last-child {
    margin-bottom: 0pt;
  }
  
  
  /* Title, authors */
  /*
  .madoko .title {
    font-size: xx-large;
    font-weight: bold;
    margin-bottom: 1ex;
  }
  
  .madoko .subtitle {
    font-size: x-large;
    margin-bottom: 1ex;
    margin-top: -1ex;
  }
  
  .madoko .titleblock>* {
    margin-left: auto;
    margin-right: auto;
    text-align: center;
  }
  
  .madoko .titleblock table {
    width: 80%;
  }
  
  .madoko .authorblock .author {
    font-size: large;
  }
  
  .madoko .titlenote {
    margin-top: -0.5ex;
    margin-bottom: 1.5ex;
  }
  */
  
  /* Lists */
  
  .madoko ul.list-star {
    list-style-type: disc;
  }
  
  .madoko ul.list-dash {
      list-style-type: none !important;
  }
  
  .madoko ul.list-dash > li:before {
      content: "\2013"; 
      position: absolute;
      margin-left: -1em; 
  }
  
  .madoko ul.list-plus {
    list-style-type: square;
  }
  
  /* Tables */
  .madoko table.madoko {
    border-collapse: collapse;
  }
  .madoko td, .madoko th {
    padding: 0ex 0.5ex;
    margin: 0pt;
    vertical-align: top;
  }
  
  .madoko .cell-border-left {
    border-left: 1px solid black;
  }
  .madoko .cell-border-right {
    border-right: 1px solid black;
  }
  
  
  .madoko thead>tr:first-child>.cell-line,
  .madoko tbody:first-child>tr:first-child>.cell-line {
    border-top: 1px solid black;
    border-bottom: none;
  }
  
  .madoko .cell-line, .madoko .cell-double-line {
    border-bottom: 1px solid black;
    border-top: none;
  }
  
  .madoko .cell-double-line {
    border-top: 1px solid black;
    padding-top: 1.5px !important;
  }
  
  
  /* Math Pre */
  .madoko .input-mathpre .MathJax_Display {
    text-align: left !important;
  }
  
  .madoko div.input-mathpre {
    text-align: left;
    margin-top: 1.5ex;
    margin-bottom: 1ex;
  }
  
  .madoko .math-rendering {
    color: gray;
  }
  
  /* Math */
  .madoko .mathdisplay {
    text-align: center;
  }
  
  
  /*---------------------------------------------------------------------------
    Default style for syntax highlighting
  ---------------------------------------------------------------------------*/
  
  .highlighted                        { color: black; }
  .highlighted .token.identifier      { }
  .highlighted .token.operators       { }
  .highlighted .token.keyword         { color: blue }
  .highlighted .token.string          { color: maroon } 
  .highlighted .token.string.escape   { color: gray }
  .highlighted .token.comment         { color: darkgreen }
  .highlighted .token.comment.doc     { font-style: normal }
  .highlighted .token.constant        { color: purple; }
  .highlighted .token.entity          {  }
  .highlighted .token.tag             { color: blue }
  .highlighted .token.info-token      { color: black }
  .highlighted .token.warn-token      { color: black }
  .highlighted .token.error-token     { color: darkred }
  .highlighted .token.debug-token     { color: gray }
  .highlighted .token.regexp          { color: maroon }
  .highlighted .token.attribute.name  { color: navy }
  .highlighted .token.attribute.value { color: maroon }
  .highlighted .token.constructor     { color: purple }
  .highlighted .token.namespace       { color: navy }
  .highlighted .token.header          { color: navy }
  .highlighted .token.type            { color: teal } 
  .highlighted .token.type.delimiter  { color: teal; } 
  .highlighted .token.predefined      { color: navy }
  .highlighted .token.invalid         { border-bottom: red dotted 1px }
  .highlighted .token.code            { color: maroon }
  .highlighted .token.code.keyword    { color: navy }
  .highlighted .token.typevar         { font-style: italic; }
  
  .highlighted .token.delimiter   {  } /* .[curly,square,parenthesis,angle,array,bracket] */
  .highlighted .token.number      {  }    /* .[hex,octal,binary,float] */
  .highlighted .token.variable    {  }  /* .[name,value]  */
  .highlighted .token.meta        { color: navy }      /* .[content] */
  
  .highlighted .token.bold            { font-weight: bold; }
  .highlighted .token.italic          { font-style: italic; }
  
  
  /* Pretty formatting of code */
  .madoko pre.pretty, .madoko code.pretty { 
    font-family: Cambria,Times,Georgia,serif;
    font-size: 100%;
  }
  
  .madoko .pretty table {
    border-collapse: collapse;
  }
  .madoko .pretty td {
    padding: 0em;
  }
  .madoko .pretty td.empty {
    min-width: 1.5ex;
  }
  .madoko .pretty td.expander {
    width: 100em;
  }
  .madoko .pretty .token.identifier         { font-style: italic }
  .madoko .pretty .token.constructor        { font-style: italic }
  
  
  /* ---------------------------------------------------
     Styling for full documents
  ----------------------------------------------------*/
  body.madoko {
    font-family: Cambria,"Times New Roman","Liberation Serif","Times",serif;
    -webkit-text-size-adjust: 100%;       /* so math displays well on mobile devices */
    text-rendering: optimizeLegibility;
  }
  
  body.madoko {
    max-width: 88ex; /* about 88 characters */
    margin: 1em auto;
    padding: 0em 2em;  
  }
  
  body.preview.madoko {
    padding: 0em 1em;
  }
  
  .madoko p,
  .madoko li {
    text-align: justify;
  }
  
  /* style headings nicer, especially h5 and h6 */
  .madoko h1, .madoko h2, .madoko h3, .madoko h4 { 
    margin-top: 1.22em; 
    margin-bottom: 1ex;
  }
  .madoko h1+p, .madoko h2+p, .madoko h3+p, .madoko h4+p, .madoko h5+p  { 
    margin-top: 1ex;    
  }
  .madoko h5, .madoko h6 { 
    margin-top: 1ex;
    font-size: 1em;
  }
  .madoko h5 { 
    margin-bottom: 0.5ex;
  }
  .madoko h5 + p {
    margin-top: 0.5ex;
  }
  .madoko h6 { 
    margin-bottom: 0pt;
  }
  .madoko h6 + p {
    margin-top: 0pt;
  }
  
  
  /* Fix monospace display (see http://code.stephenmorley.org/html-and-css/fixing-browsers-broken-monospace-font-handling/) */
  .madoko pre, .madoko code, .madoko kbd, .madoko samp, .madoko tt, .madoko .monospace, .madoko .token.indent, .madoko .reveal pre, .madoko .reveal code, .madoko .email {
    font-family: Consolas,"Andale Mono WT","Andale Mono",Lucida Console,Monaco,monospace,monospace;
    font-size: 0.85em;
  }
  .madoko pre code, .madoko .token.indent {
    font-size: 0.95em;
  }
  
  .madoko pre code {
    font-family: inherit !important;
  }
  
  /* Code prettify */
  .madoko ol.linenums li {
    background-color: white;
    list-style-type: decimal;
  }
  
  /* Merging */
  .madoko .remote {
    background-color: #F0FFF0;
  }
  .madoko .remote + * {
    margin-top: 0pt;
  }
  
  /* ---------------------------------------------------
     Print settings
  ----------------------------------------------------*/
  
  @media print {
    body.madoko {
      font-size: 10pt;
    }
    @page {
      margin: 1in 1.5in;
    }
  }
  
  /* ---------------------------------------------------
     Mobile device settings
  ----------------------------------------------------*/
  
  @media only screen and (max-device-width:1024px) {
    body.madoko {
      padding: 0em 1em;
    }
  }
  
    </style>
  
  </head>
<body class="madoko">

<div class="body madoko" style="line-adjust:0">

<div class="titleblock align-center para-block" style="text-align:center;line-adjust:0">
<div class="titleheader align-center" style="text-align:center;line-adjust:0">
<div class="title para-block" style="font-size:xx-large;font-weight:bold;margin-bottom:0.5ex;line-adjust:0">W205 Lab 6</div></div>
<div class="authors align-center" style="text-align:center;width:80%;line-adjust:0"><table class="authorrow columns block"  style="margin-top:2ex;width:100%;line-adjust:0">
<tbody><tr><td class="author column"  style="text-align:center;line-adjust:0">
<div class="authorname" style="font-size:large;line-adjust:0">Yiran Sheng</div>
<div class="authoraddress" style="line-adjust:0">UCB</div>
<div class="authoremail email" style="line-adjust:0">yiran@ischool.berkeley.edu</div></td></tr></tbody></table></div></div>
<div class="abstract" >
<p class="noindent">W205 Lab 6. An    Introduction    to    Apache    Spark    and    Spark    SQL. Spark is setup on a cluster of three nodes, and running on Yarn. </p></div>
<h2 id="sec-step-01-check-installation-and-prepare-data"    style="display:block;bookmark:1.&#8194;Step 0.1    Check    Installation    and    Prepare    Data;level:1"><span class="heading-before"><span class="heading-label">1</span>.&#8194;</span>Step 0.1    Check    Installation    and    Prepare    Data</h2>
<p class="noindent">There seems to be a problem with AMI ucbw205_complete_plus_postgres (ami-bff58fda), where Spark is not configured properly. 
</p>
<pre class="para-block pre-fenced pre-fenced3" ><code>[root@ip-10-0-0-61 ~]# echo $SPARK_HOME
/root/spark15</code></pre>
<p class="noindent para-continued">Cause is in <code class="code code1" >/etc/profile</code> there&#39;s a weird line:
</p>
<pre class="para-block pre-fenced pre-fenced3" ><code>export SPARK_HOME=$HOME/spark15  </code></pre>
<p class="noindent para-continued">After commenting it out, everything seemed fine. Next adding spark <code class="code code1" >bin/</code> directory to <code class="code code1" >PATH</code> variable. 
</p>
<pre class="para-block pre-fenced pre-fenced3" ><code>cat &lt;&lt;EOF &gt;&gt; /root/.bash_profile
export PATH=$SPARK_HOME/bin:$PATH
EOF  </code></pre><h2 id="sec-step-02-check-spark-on-yarn-client-mode"    style="display:block;bookmark:2.&#8194;Step 0.2 Check Spark on yarn client mode;level:1"><span class="heading-before"><span class="heading-label">2</span>.&#8194;</span>Step 0.2 Check Spark on yarn client mode</h2>
<p class="noindent">I have setup a three-ec2-instance cluster from base ami, in this step try to check if spark runs properly on yarn. 
</p>
<p class="indent">First, check if yarn nodemanager and resourcemanager are running. 
</p>
<pre class="para-block pre-fenced pre-fenced3" ><code>[root@ip-10-0-0-61 ~]# yarn node -list
15/10/09 19:48:14 INFO client.RMProxy: Connecting to ResourceManager at master/10.0.0.61:8032
Total Nodes:3
         Node-Id         Node-State    Node-Http-Address    Number-of-Running-Containers
    slave1:56898            RUNNING          slave1:8042                               0
    master:52195            RUNNING          master:8042                               0
    slave2:44917            RUNNING          slave2:8042                               0
[root@ip-10-0-0-61 ~]# 
  </code></pre>
<p class="noindent para-continued">Next, start <code class="code code1" >spark-shell</code> in <code class="code code1" >yarn-client</code> mode
</p>
<pre class="para-block pre-fenced pre-fenced3" ><code>[root@ip-10-0-0-61 ~]# spark-shell --master yarn-client  
...
15/10/09 19:50:15 INFO yarn.Client: Application report for application_1444418436488_0003 (state: ACCEPTED)
...</code></pre>
<p class="noindent para-continued">Logs indiate <code class="code code1" >yarn</code> has started a master container for spark. And spark shell is successfully loaded.
</p>
<pre class="para-block pre-fenced pre-fenced3" ><code>scala&gt;  </code></pre>
<p class="noindent para-continued">List of yarn applications produces:
</p>
<pre class="para-block pre-fenced pre-fenced3" ><code>[root@ip-10-0-0-59 ~]# yarn application -list
15/10/09 20:02:48 INFO client.RMProxy: Connecting to ResourceManager at master/10.0.0.61:8032
Total number of applications (application-types: [] and states: [SUBMITTED, ACCEPTED, RUNNING]):1
                Application-Id        Application-Name        Application-Type          User         Queue                 State           Final-State           Progress                           Tracking-URL
application_1444418436488_0004             Spark shell                   SPARK          root     root.root               RUNNING             UNDEFINED                10%                     http://master:4040  </code></pre>
<p class="noindent para-continued">Confirms spark is running on yarn. 
</p><h2 id="sec-step-03-download-data-and-copy-to-hdfs"    style="display:block;bookmark:3.&#8194;Step 0.3 Download Data and copy to hdfs;level:1"><span class="heading-before"><span class="heading-label">3</span>.&#8194;</span>Step 0.3 Download Data and copy to hdfs</h2>
<p class="noindent">Clone github and copy file to hdfs.
</p>
<pre class="para-block pre-fenced pre-fenced3" ><code>[root@ip-10-0-0-61 ~]# git clone : https://github.com/UC-Berkeley-ISchool/w205-labs-exercises/tree/master/data/Crimes_-_2001_to_present_data
[root@ip-10-0-0-61 ~]# cd w205-labs-exercises/data/Crimes_-_2001_to_present_data/ 
[root@ip-10-0-0-61 ~]# gunzip Crimes_-_2001_to_present.csv.gz
[root@ip-10-0-0-61 ~]# hdfs dfs -mkdir w205lab6
[root@ip-10-0-0-61 ~]# hdfs dfs -copyFromLocal Crimes_-_2001_to_present_data.csv w205lab6/Crimes_-_2001_to_present_data.csv
[root@ip-10-0-0-61 ~]# wget https://s3.amazonaws.com/ucbdatasciencew205/labs/weblog_lab.csv -O - | hdfs dfs -put - w205lab6/weblog_lab.csv
[root@ip-10-0-0-61 ~]# hdfs dfs -ls w205lab6</code></pre>
<p class="noindent para-continued">Output:
</p>
<pre class="para-block pre-fenced pre-fenced3" ><code>Found 2 items
-rw-r--r--   1 root supergroup 1376617753 2015-10-09 20:35 w205lab6/Crimes_-_2001_to_present.csv
-rw-r--r--   1 root supergroup    5192992 2015-10-09 20:40 w205lab6/weblog_lab.csv
</code></pre></div><span data-line=""></span>
</body>

</html>
